I have selected a Microchip PIC microcontroller to manage the power sequencing for my design. PlatformIO supports boards with a 32-bit platform, i.e. [PIC32 microcontrollers](https://docs.platformio.org/en/latest/platforms/microchippic32.html). I picked the [32MX250F128B](https://www.microchip.com/wwwproducts/en/PIC32MX250F128B) model which is a nice middle-of-the-road microcontroller in regards to power and functionality. Importantly, it has I2C (to communicate with the [BQ76920](../BQ7692006) battery monitor) and UART (to communicate with the ESP32), along with built-in USB OTG. Additionally, an external crystal isn't required since the chip does have its own [built-in 8MHz RC Oscillator](https://microchipdeveloper.com/32bit:mx-osc), accurate to +/-0.9%, see datasheet pg. 275.

I have based my circuit design off of the [HelvePic32](https://www.helvepic32.org/assembly-instructions/) board which courteously provides its design files (I seem to remember reading that it was based off of the Digilent DP32 mentioned below but I can't find that reference again), also referencing the [PIC32MX1XX/2XX Datasheet](https://ww1.microchip.com/downloads/en/DeviceDoc/PIC32MX1XX2XX%20283644-PIN_Datasheet_DS60001168L.pdf), [PIC32 Flash Programming Spec.](https://ww1.microchip.com/downloads/en/DeviceDoc/PIC32-Flash-Programming-Specification-DS60001145.pdf), [PICkit4 Quick Start Guide](http://ww1.microchip.com/downloads/en/devicedoc/50002721a.pdf), this [In-Circuit Programming (ISP)](https://www.microsemi.com/document-portal/doc_view/129973-lpf-ac386-an) reference by Microsemi, and this [PIC programming Instructable](https://www.instructables.com/Programming-PIC-Microcontrollers/). One important thing to note is that in order to program the PIC32 using the Arduino framework (like PlatformIO uses) the chip needs a bootloader installed. The chips that come in [chipKIT](https://chipkit.net/about-us/)-compatible boards come with this bootloader pre-installed, but since I am not starting from a board kit designed to be compatible with the Arduino framework, I need to prefrom this step myself.

In order to program a PIC32 fresh from the factory, either a 4-wire JTAG or a 2-wire ICSP is needed. Microchip seems to want to sell a specialized programmer (the PICkit4) for programming using the 2-wire protocol, which needs a special sequence of reset and command signals as specified in the [programming specification](https://ww1.microchip.com/downloads/en/DeviceDoc/PIC32-Flash-Programming-Specification-DS60001145.pdf), but JTAG also works just fine (not to mention having a JTAG debugger on hand will be nice for future projects). I have included both interfaces on the schematic for flexibility, but in the end I may only include just the one on the final board. Programming in this case takes place in the [MPLAB X IDE](https://www.microchip.com/en-us/development-tools-tools-and-software/mplab-x-ide) which is provided by Microchip. With this tool it should be possible to configure and flash a bootloader image to the chip.

This brings up the issue of the bootloader code itself. The programming utility ([pic32prog](https://github.com/sergev/pic32prog?utm_source=platformio.org&utm_medium=docs)) used by PlatformIO shows support for the [AN1388 HID Bootloader](https://www.microchip.com/wwwappnotes/appnotes.aspx?appnote=en554836) (HID in this case stands for Human Interface Device, i.e. the USB port). Additionally, some of the existing boards also provide their bootloaders, though these seem to only be as compiled `.hex` image files in some cases, so some communication might need to happen to get the source. The [Digilent DP32](https://reference.digilentinc.com/microprocessor/dp32/start) has a [link](https://reference.digilentinc.com/_media/reference/microprocessor/dp32/chipkit-dp32-v01000303.zip) to its bootloader `.hex` in its [chipKIT DP32 Reference Manual](https://reference.digilentinc.com/chipkit_dp32/refmanual). Some entries on the [chipKIT boards list](https://chipkit.net/wiki/index.php?title=Boards) have a link to a [GitHub repo with various bootloaders](https://github.com/chipKIT32/PIC32-avrdude-bootloader/) both as `.hex` files and as source (the link to the file from some of the pages might 404 but the repos are still there). Between these it should be possible to get a bootloader compatible with PlatformIO set up on the chip.

Now, you may be asking "why don't you just use one of the existing `.hex` files?" Well, I might be able to, however since my board has its peripherals routed differently (the UARTs can be routed to any pin so I picked the two unused oscillator pins), I expect I will need to change some system configuration settings and recompile a bootloader for that.
